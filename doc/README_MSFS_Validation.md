# MSFS环境验证程序

本目录包含MSFS（Smart Manufacturing Flow Scheduling）环境的完整验证程序，用于验证环境实现是否与文档说明一致。

## 文件说明

### 验证程序文件

1. **`verify_msfs_environment.py`** - MSFS环境验证器主文件
   - `MSFSEnvironmentValidator`类：核心验证逻辑
   - 包含观测空间、动作空间、奖励机制、全局状态等验证功能

2. **`run_msfs_validation.py`** - 验证程序运行脚本
   - 提供多种验证模式和选项
   - 支持不同难度和配置的验证

## 使用方法

### 基础验证

```bash
# 快速验证（推荐）
python run_msfs_validation.py

# 显示帮助信息
python run_msfs_validation.py --help
```

### 不同验证模式

```bash
# 全面验证（测试所有难度和模式）
python run_msfs_validation.py --comprehensive

# 仅验证基础模式
python run_msfs_validation.py --basic-only

# 仅验证CTDE模式
python run_msfs_validation.py --ctde-only
```

### 专项验证

```bash
# 角色涌现专项验证
python run_msfs_validation.py --role-emergence

# 效率重点专项验证
python run_msfs_validation.py --efficiency

# 课程学习验证
python run_msfs_validation.py --curriculum
```

## 验证内容

### 核心验证项目

1. **观测空间验证（24维）**
   - 自身状态（10维）：工作站位置、移动冷却、携带信息、专门化信息
   - 全局信息（7维）：队列长度、订单统计、时间信息
   - 队友信息（7维）：队友位置、状态、携带信息

2. **动作空间验证（8维）**
   - 移动动作（3个）：RAW/ASSEMBLY/PACKING
   - 订单处理动作（4个）：PULL_ORDER、START_PROCESSING、COMPLETE_STAGE、DELIVER_ORDER
   - 等待动作（1个）：WAIT

3. **奖励机制验证**
   - 主要任务奖励：简单/复杂订单完成奖励
   - 时间惩罚：步数惩罚、空闲惩罚
   - 角色涌现奖励：专门化奖励、完成奖励

4. **CTDE全局状态验证（42维）**
   - 智能体状态（16维）
   - 工作站状态（18维）
   - 全局统计（8维）

5. **系统功能验证**
   - 工作站系统验证
   - 订单系统验证
   - 专门化机制验证

### 支持的难度配置

- **Easy**：高奖励值，低惩罚，较短专门化阈值
- **Normal**：平衡的奖励惩罚设置
- **Hard**：低奖励值，高时间压力

### 专项配置验证

- **角色涌现重点**：高专门化奖励，高角色切换惩罚
- **效率重点**：高时间压力，低专门化奖励
- **课程学习**：三阶段渐进式配置

## 验证结果解读

### 退出码

- `0` - 验证通过
- `1` - 验证失败或出现错误

### 验证报告

验证程序会输出详细的验证报告，包括：

- ✅ **验证通过的项目数**
- ❌ **发现错误数量**
- ⚠️ **警告信息数量**

#### 错误类型

1. **维度错误**：观测/动作/全局状态维度不匹配
2. **数据类型错误**：数据类型不符合要求
3. **数据范围错误**：数据值超出预期范围
4. **功能错误**：系统功能异常

#### 警告类型

1. **范围警告**：数据值在边界附近
2. **逻辑警告**：状态逻辑不一致
3. **配置警告**：配置参数异常

## 示例输出

```
🚀 开始MSFS环境快速验证...
================================================================================
MSFS环境验证程序
================================================================================
验证难度: normal
验证模式: CTDE

✅ 环境创建成功: normal难度 (CTDE模式)
   - 智能体数量: 2
   - 智能体ID: ['agent_0', 'agent_1']
   - 最大步数: 50
   - 观测空间维度: 24
   - 动作空间维度: 8
   - 全局状态维度: 42

🔍 验证观测空间...
✅ 智能体agent_0观测维度正确: 24
✅ agent_0观测结构验证完全通过
...
================================================================================
验证报告
================================================================================
✅ 验证通过的项目: 30
❌ 发现错误: 0
⚠️  警告信息: 2

✅ 核心功能验证通过！存在一些需要注意的警告项。

🎉 验证完成！MSFS环境实现与文档完全一致。
```

## 故障排除

### 常见问题

1. **导入错误**
   ```
   ModuleNotFoundError: No module named 'Env.MSFS'
   ```
   **解决方案**：确保在项目根目录运行验证程序

2. **环境创建失败**
   ```
   ❌ 环境创建失败: ...
   ```
   **解决方案**：检查MSFS环境代码是否完整，依赖是否安装

3. **维度不匹配**
   ```
   ❌ 智能体agent_0观测维度不匹配: 期望24, 实际XX
   ```
   **解决方案**：检查环境实现与文档是否一致

### 调试技巧

1. **逐个验证**：使用 `--basic-only` 或 `--ctde-only` 分别测试
2. **特定配置**：使用专项验证选项测试特定功能
3. **详细日志**：观察验证过程中的详细输出信息

## 扩展和定制

### 添加新的验证项目

在 `MSFSEnvironmentValidator` 类中添加新的验证方法：

```python
def validate_new_feature(self):
    """验证新功能"""
    print("\n🔍 验证新功能...")
    try:
        # 验证逻辑
        print("✅ 新功能验证通过")
    except Exception as e:
        error_msg = f"新功能验证失败: {e}"
        self.errors.append(error_msg)
        print(f"❌ {error_msg}")
```

### 添加新的验证模式

在 `run_msfs_validation.py` 中添加新的运行选项：

```python
def run_custom_validation():
    """运行自定义验证"""
    validator = MSFSEnvironmentValidator()
    try:
        # 自定义验证逻辑
        success = validator.run_validation("custom", True)
        return 0 if success else 1
    finally:
        validator.cleanup()
```

## 技术细节

### 验证原理

1. **维度验证**：检查观测、动作、全局状态维度是否符合文档说明
2. **范围验证**：检查数据值是否在合理范围内
3. **类型验证**：检查数据类型是否正确
4. **功能验证**：测试环境功能是否正常工作
5. **一致性验证**：检查各组件之间的一致性

### 依赖项

- `numpy`：数值计算和数组操作
- `sys`, `os`：系统操作
- `typing`：类型提示
- MSFS环境代码：`Env.MSFS`模块

## 版本信息

- **创建日期**：2025-01-08
- **适用版本**：MSFS环境 v1.0+
- **Python版本**：3.7+
- **验证标准**：基于 `tutorials/MSFS简介.md` 文档

---

## 联系信息

如有问题或建议，请参考：
- MSFS环境文档：`tutorials/MSFS简介.md`
- 环境代码：`Env/MSFS/` 目录
- 项目说明：`CLAUDE.md`